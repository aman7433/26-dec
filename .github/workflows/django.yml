name: Deploy to AWS EC2

on:
  workflow_dispatch:
  # push:
  #   branches:
  #     - main  # Trigger the action on pushes to the main branch

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # Checkout the repository
    - name: Checkout repository
      uses: actions/checkout@v3

    # Set up SSH for connecting to EC2
    - name: Set up SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.AWS_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa  # Use private key stored in GitHub Secrets
        chmod 600 ~/.ssh/id_rsa  # Secure the SSH private key file

    # SSH into the EC2 instance and deploy the project
    - name: Deploy to EC2
      run: |
        # Use StrictHostKeyChecking=no to bypass the SSH host key check (NOT recommended for production)
        ssh -o StrictHostKeyChecking=no ubuntu@${{ secrets.EC2_PUBLIC_IP }} << 'EOF'
          # Clone the repository or pull if it already exists
          cd /home/ubuntu
          git clone https://github.com/aman7433/26-dec.git || (cd 26-dec && git pull)

          # Navigate to the project directory
          cd 26-dec

          # Create a Python virtual environment
          python3 -m venv venv

          # Activate the virtual environment
          source venv/bin/activate

          # Upgrade pip
          pip install --upgrade pip

          # Install dependencies from requirements.txt
          pip install -r requirements.txt

          # Run Django migrations
          python manage.py migrate

          # Start the Django development server (optional, not recommended for production)
          nohup python manage.py runserver 0.0.0.0:8000 &
        EOF
